---
- name: Install the virt-lightning dependencies
  package:
    name: "{{ virt_lightning_packages }}"

  become: true
- name: Start libvirt
  service:
    name: libvirtd
    state: started
  become: true
- name: Add the find users to the current users
  user:
    name: "{{ansible_user_id}}"
    groups: "{{ virt_lightning_groups }}"
  become: true
- name: reset ssh connection to reload the groups
  meta: reset_connection
- name: Push the working directory
  synchronize:
    src: ../../virt-lightning
    dest: ~/
  when: dev_mode is defined
- name: Fetch virt-lightning master branch
  git:
    repo: 'https://github.com/virt-lightning/virt-lightning'
    dest: ~/virt-lightning
  when: dev_mode is not defined
- name: Prepare the virtualenv
  shell: |
    python3 -m venv ~/venv
    . ~/venv/bin/activate
    pip install -e ~/virt-lightning
- name: Prepare the configuration directory
  file:
    path: ~/.config/virt-lightning
    state: directory
- name: Write the configuration file
  template:
    src: config.ini.j2
    dest: ~/.config/virt-lightning/config.ini
- name: Create the pool directory
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ virt_lightning_qemu_owner }}"
    group: "{{ virt_lightning_qemu_group }}"
    mode: "0775"
  with_items:
    - /var/lib/virt-lightning/pool
    - /var/lib/virt-lightning/pool/upstream
  become: true
  when: virt_lightning_qemu_uri == "qemu:///system"
